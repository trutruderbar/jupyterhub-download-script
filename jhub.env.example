# 全域安裝參數，可由所有腳本自動載入。
# 需要不同設定可以編輯本檔案或設定 JHUB_ENV_FILE 指向另一路徑。

# ============================================================
# 認證設定
# ============================================================

# 認證模式：native（預設）/ github / azuread / ubilink
export AUTH_MODE=native

# Native 認證模式設定
export ADMIN_USERS_CSV="admin,user1,user2"
export ADMIN_USER="admin"

# GitHub OAuth 設定（當 AUTH_MODE=github 時使用）
# export AUTH_MODE=github
# export GITHUB_CLIENT_ID="your_github_client_id"
# export GITHUB_CLIENT_SECRET="your_github_client_secret"
# export GITHUB_CALLBACK_URL="https://your-hub.example.com/hub/oauth_callback"

# Azure AD OAuth 設定（當 AUTH_MODE=azuread 時使用）
# export AUTH_MODE=azuread
# export AZUREAD_CLIENT_ID="your_azuread_client_id"
# export AZUREAD_CLIENT_SECRET="your_azuread_client_secret"
# export AZUREAD_CALLBACK_URL="https://your-hub.example.com/hub/oauth_callback"
# export AZUREAD_TENANT_ID="your_tenant_id"

# 自訂 SSO 設定（當 AUTH_MODE=ubilink 時使用）
# export AUTH_MODE=ubilink
# export UBILINK_AUTH_ME_URL="https://your-auth-api.example.com/api/auth/me"
# export UBILINK_LOGIN_URL="https://your-login-page.example.com/login"

# ============================================================
# JupyterHub 基本設定
# ============================================================

export JHUB_NS="${JHUB_NS:-jhub}"
export JHUB_RELEASE="jhub"
export JHUB_CHART_VERSION="4.2.0"
export HELM_TIMEOUT="25m0s"

# ============================================================
# 網路與代理設定
# ============================================================

export ENABLE_NGINX_PROXY=false
# export NGINX_PROXY_SERVER_NAME="your-hub.example.com your-server-ip $(hostname -f)"
# export NGINX_PROXY_HTTPS_PORT=443
# export NGINX_PROXY_CERT_FILE=/path/to/your/cert.crt
# export NGINX_PROXY_KEY_FILE=/path/to/your/key.key
# export TLS_CERT_FILE="$NGINX_PROXY_CERT_FILE"
# export TLS_KEY_FILE="$NGINX_PROXY_KEY_FILE"
# export JHUB_FRAME_ANCESTORS="https://your-hub.example.com https://$(hostname -f) http://localhost:8080"

export NODEPORT_FALLBACK_PORT=30080
export PF_BIND_ADDR="0.0.0.0"
export PF_LOCAL_PORT=18080
export PF_AUTOSTART=true

# ============================================================
# 使用者環境設定
# ============================================================

# 關閉 idle culler（避免閒置一段時間自動關閉使用者 pod）
export ENABLE_IDLE_CULLER=false

# Notebook 映像與儲存配置
export SINGLEUSER_IMAGE="myorg/pytorch-jhub:24.10"
export SINGLEUSER_IMAGE_PULL_POLICY="IfNotPresent"
export PVC_SIZE="128Gi"
export SINGLEUSER_STORAGE_CLASS="microk8s-hostpath"

# Storage 控制策略：
# - 允許使用者 sudo/apt（root filesystem 必須可寫）
# - 限制「容器本機可寫空間」（包含 /, /home 等 image layer 的 overlay + logs + emptyDir），超過就會被 kubelet evict
# - /workspace/storage 是獨立的 PV（Ceph/hostPath 掛載），不會計入 ephemeral-storage
export SINGLEUSER_STORAGE_TYPE="none"
export SINGLEUSER_READONLY_ROOTFS=false
export SINGLEUSER_MOUNT_JHUB_LOGS=false
export SINGLEUSER_EPHEMERAL_STORAGE_REQUEST="1Gi"
export SINGLEUSER_EPHEMERAL_STORAGE_LIMIT="640Gi"
export HOSTPATH_PROVISIONER_IMAGE="docker.io/cdkbot/hostpath-provisioner:1.5.0"

# ============================================================
# GPU 設定
# ============================================================

export USE_GPU_OPERATOR=false
export GPU_DRIVER_MODE="host"
export GPU_OPERATOR_DRIVER_VERSION="580.65.06"

# ============================================================
# Admin User NodePort/Port-forward
# ============================================================

export EXPOSE_ADMINUSER_NODEPORT=false
export ADMINUSER_TARGET_PORT=8000
export ADMINUSER_NODEPORT=32081
export ADMINUSER_PORTFORWARD=false
export ADMINUSER_PF_PORT=18081
export ADMINUSER_PF_BIND_ADDR="127.0.0.1"

# ============================================================
# InfiniBand / RDMA 設定
# ============================================================

export ENABLE_IB=false
export IB_NIC_POLICY_NAME="nic-cluster-policy"
export IB_NIC_POLICY_TEMPLATE_FILE="/path/to/templates/nic-cluster-policy.yaml"
export IB_RSDP_REPOSITORY="ghcr.io/mellanox"
export IB_RSDP_IMAGE="k8s-rdma-shared-dev-plugin"
export IB_RSDP_VERSION="v1.5.2"
export IB_RSDP_IMAGE_TAR="/path/to/offline-images/k8s-rdma-shared-dev-plugin-v1.5.2.tar"
export IB_RSDP_CONFIG='{"configList":[{"resourceName":"rdma_shared_device","rdmaHcaMax":63,"selectors":{"vendors":["15b3"]}}]}'
export IB_RESOURCE_NAME="rdma/rdma_shared_device"
export IB_RESOURCE_COUNT=1

# ============================================================
# MPI Operator 設定
# ============================================================

export ENABLE_MPI_OPERATOR=false
export MPI_OPERATOR_NAMESPACE="mpi-operator"
export MPI_USERS_CSV="user1,user2"
export MPI_USER_NAMESPACE_PREFIX="mpi"
export MPI_USER_SERVICE_ACCOUNT_PREFIX="jhub-mpi-sa"
export MPI_NS_REQUESTS_CPU="64"
export MPI_NS_REQUESTS_MEMORY="256Gi"
export MPI_NS_LIMITS_CPU="64"
export MPI_NS_LIMITS_MEMORY="256Gi"
export MPI_NS_GPUS="8"
export MPI_NS_PODS="32"

# ============================================================
# 共享儲存設定
# ============================================================

export SHARED_STORAGE_ENABLED=false
export SHARED_STORAGE_SIZE=1Ti
export SHARED_STORAGE_PATH="/path/to/shared/storage"
