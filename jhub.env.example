# =============================================================================
# JupyterHub 部署環境變數配置範例
# =============================================================================
#
# 使用說明：
# 1. 複製此檔案為 jhub.env: cp jhub.env.example jhub.env
# 2. 根據您的環境修改相關變數
# 3. 執行部署: sudo ./install_jhub.sh
#

# =============================================================================
# 基本配置
# =============================================================================

# JupyterHub namespace
export JHUB_NS="${JHUB_NS:-jhub}"

# JupyterHub Helm Release 名稱
export JHUB_RELEASE="jhub"

# JupyterHub Chart 版本
export JHUB_CHART_VERSION="4.2.0"

# Helm 安裝超時時間
export HELM_TIMEOUT="25m0s"

# =============================================================================
# 認證設定
# =============================================================================

# 認證模式 (native/github/azuread/ubilink)
export AUTH_MODE=native

# 管理員使用者列表 (逗號分隔)
export ADMIN_USERS_CSV="admin"
export ADMIN_USER="admin"

# ---------- GitHub OAuth 設定 ----------
# (當 AUTH_MODE=github 時使用)
# export GITHUB_CLIENT_ID="your_github_client_id"
# export GITHUB_CLIENT_SECRET="your_github_client_secret"
# export GITHUB_CALLBACK_URL="https://your-jupyterhub.example.com/hub/oauth_callback"

# ---------- Azure AD OAuth 設定 ----------
# (當 AUTH_MODE=azuread 時使用)
# export AZUREAD_CLIENT_ID="your_azuread_client_id"
# export AZUREAD_CLIENT_SECRET="your_azuread_client_secret"
# export AZUREAD_TENANT_ID="your_tenant_id"
# export AZUREAD_CALLBACK_URL="https://your-jupyterhub.example.com/hub/oauth_callback"

# ---------- 自訂 SSO 設定 ----------
# (當 AUTH_MODE=ubilink 或其他自訂 SSO 時使用)
# export UBILINK_AUTH_ME_URL="https://your-auth-api.example.com/api/auth/me"
# export UBILINK_LOGIN_URL="https://your-login-page.example.com/login"

# =============================================================================
# 網路與存取設定
# =============================================================================

# NodePort 埠號 (預設 30080)
export NODEPORT_FALLBACK_PORT=30080

# Port-forward 設定
export PF_BIND_ADDR="0.0.0.0"
export PF_LOCAL_PORT=18080
export PF_AUTOSTART=true

# ---------- HTTPS 反向代理 (Nginx) ----------
# 啟用 Nginx HTTPS 反向代理
export ENABLE_NGINX_PROXY=false

# Nginx 伺服器名稱 (多個用空格分隔)
# export NGINX_PROXY_SERVER_NAME="jhub.example.com"

# Nginx HTTPS 埠號
# export NGINX_PROXY_HTTPS_PORT=443

# TLS 憑證與金鑰路徑 (請替換為您的實際路徑)
# export NGINX_PROXY_CERT_FILE=/path/to/your/cert.crt
# export NGINX_PROXY_KEY_FILE=/path/to/your/cert.key
# export TLS_CERT_FILE="$NGINX_PROXY_CERT_FILE"
# export TLS_KEY_FILE="$NGINX_PROXY_KEY_FILE"

# Frame Ancestors (用於 CSP，允許嵌入的來源)
# export JHUB_FRAME_ANCESTORS="https://jhub.example.com http://localhost:8080"

# =============================================================================
# Admin User NodePort/Port-forward
# =============================================================================

# 啟用 Admin User NodePort
export EXPOSE_ADMINUSER_NODEPORT=true
export ADMINUSER_TARGET_PORT=8000
export ADMINUSER_NODEPORT=32081

# 啟用 Admin User Port-forward
export ADMINUSER_PORTFORWARD=false
export ADMINUSER_PF_PORT=18081
export ADMINUSER_PF_BIND_ADDR="127.0.0.1"

# =============================================================================
# Single-user 容器設定
# =============================================================================

# Single-user 容器映像
export SINGLEUSER_IMAGE="myorg/pytorch-jhub:24.10"

# 映像拉取策略 (Always/IfNotPresent/Never)
export SINGLEUSER_IMAGE_PULL_POLICY="IfNotPresent"

# 使用者儲存空間大小
export PVC_SIZE="128Gi"

# 儲存類別 (例如 cephfs-nfs、hostpath、nfs 等)
export SINGLEUSER_STORAGE_CLASS="hostpath"

# ---------- 容器儲存策略 ----------
# Storage 類型 (dynamic/static/none)
export SINGLEUSER_STORAGE_TYPE="none"

# 是否將 rootfs 設為唯讀 (false 允許使用者 sudo/apt)
export SINGLEUSER_READONLY_ROOTFS=false

# 是否掛載 JupyterHub 日誌
export SINGLEUSER_MOUNT_JHUB_LOGS=false

# Ephemeral Storage 限制 (容器本機可寫空間)
export SINGLEUSER_EPHEMERAL_STORAGE_REQUEST="1Gi"
export SINGLEUSER_EPHEMERAL_STORAGE_LIMIT="640Gi"

# =============================================================================
# GPU 設定
# =============================================================================

# 啟用 GPU Operator
export USE_GPU_OPERATOR=false

# GPU 驅動模式 (host/operator)
# - host: 使用主機上的 NVIDIA 驅動
# - operator: 由 GPU Operator 自動安裝驅動
export GPU_DRIVER_MODE="host"

# GPU Operator 驅動版本 (當 GPU_DRIVER_MODE=operator 時使用)
# export GPU_OPERATOR_DRIVER_VERSION="580.65.06"

# =============================================================================
# InfiniBand / RDMA 設定
# =============================================================================

# 啟用 NVIDIA Network Operator (InfiniBand/RDMA)
export ENABLE_IB=false

# InfiniBand NIC Policy 名稱
# export IB_NIC_POLICY_NAME="nic-cluster-policy"

# InfiniBand NIC Policy 模板檔案路徑
# export IB_NIC_POLICY_TEMPLATE_FILE="./templates/nic-cluster-policy.yaml"

# RDMA Shared Device Plugin 設定
# export IB_RSDP_REPOSITORY="ghcr.io/mellanox"
# export IB_RSDP_IMAGE="k8s-rdma-shared-dev-plugin"
# export IB_RSDP_VERSION="v1.5.2"
# export IB_RSDP_IMAGE_TAR="./offline-images/k8s-rdma-shared-dev-plugin-v1.5.2.tar"

# RDMA 資源配置 (JSON 格式)
# export IB_RSDP_CONFIG='{"configList":[{"resourceName":"rdma_shared_device","rdmaHcaMax":63,"selectors":{"vendors":["15b3"]}}]}'

# RDMA 資源名稱與數量
# export IB_RESOURCE_NAME="rdma/rdma_shared_device"
# export IB_RESOURCE_COUNT=1

# =============================================================================
# MPI 支援
# =============================================================================

# 啟用 MPI Operator (多節點分散式訓練)
# 注意：設為 false 則僅保留容器內 SSH + mpirun 模式
export ENABLE_MPI_OPERATOR=false

# (若 ENABLE_MPI_OPERATOR=true) 為特定使用者啟用 MPI namespace
# export ENABLE_MPI_USER_NS=true
# export MPI_USERS_CSV="user1,user2"

# =============================================================================
# 共享儲存設定
# =============================================================================

# 啟用共享儲存 (掛載到 /workspace/storage)
export SHARED_STORAGE_ENABLED=true

# 共享儲存大小
export SHARED_STORAGE_SIZE=1Ti

# 共享儲存路徑 (主機上的實際路徑)
# 例如 CephFS、NFS 掛載點等
export SHARED_STORAGE_PATH="/path/to/shared/storage"

# =============================================================================
# HostPath Provisioner 設定
# =============================================================================

# HostPath Provisioner 映像
export HOSTPATH_PROVISIONER_IMAGE="docker.io/cdkbot/hostpath-provisioner:1.5.0"

# =============================================================================
# 資源配額與使用量限制
# =============================================================================

# 啟用資源配額限制 (與 Usage Portal 整合)
export ENABLE_USAGE_LIMIT_ENFORCER=false

# Usage Portal URL (用於查詢使用者配額與使用量)
# export USAGE_PORTAL_URL="http://your-portal-ip:29781"

# =============================================================================
# 閒置自動關閉 (Idle Culler)
# =============================================================================

# 啟用閒置自動關閉
export ENABLE_IDLE_CULLER=false

# 閒置超時時間 (秒)
# export IDLE_TIMEOUT=3600

# =============================================================================
# 離線映像設定
# =============================================================================

# 離線映像目錄 (預設為 ./offline-images)
# export OFFLINE_IMAGES_DIR="./offline-images"

# =============================================================================
# 其他進階設定
# =============================================================================

# 自訂 Helm values 檔案路徑 (選用)
# export CUSTOM_VALUES_FILE="/path/to/custom-values.yaml"

# Kubernetes 命名空間標籤 (選用)
# export NAMESPACE_LABELS='{"environment":"production","team":"ml"}'

# 自訂登入頁面模板路徑
# export LOGIN_TEMPLATE_PATH="./templates/login.html"

# =============================================================================
# 注意事項
# =============================================================================
#
# 1. 敏感資訊安全：
#    - 請勿將包含真實密碼、Token、憑證路徑的 jhub.env 提交至版控
#    - 建議將 jhub.env 加入 .gitignore
#
# 2. 離線部署：
#    - 請確保 offline-images/ 目錄包含所有必要的映像檔
#    - 映像檔列表請參考 README.md
#
# 3. 網路設定：
#    - 如需對外開放服務，請設定防火牆規則
#    - 預設 NodePort 30080、Admin NodePort 32081
#
# 4. 儲存設定：
#    - SHARED_STORAGE_PATH 必須是主機上實際存在的目錄
#    - 建議使用 CephFS、NFS 等共享檔案系統
#
# 5. GPU 設定：
#    - 使用 GPU 前請確保主機已安裝 NVIDIA 驅動
#    - GPU_DRIVER_MODE=host 適用於已安裝驅動的環境
#
# =============================================================================
